---
output:  
  word_document:
    toc: no
    pandoc_args: ["-Fpandoc-crossref"]
fig_caption: yes
---

Sam C. Levin $^{\ast1,2,3}$, Sanne Evers $^{1,2}$, Tomos Potter$^{3}$, Mayra Pena-Guerrero $^{1,2}$,  Aldo Compagnoni $^{1,2,3}$, Dylan Z. Childs $^4$, Tiffany M. Knight $^{1,2,5\ddagger}$, Roberto Salguero-Gomez $^{3\ddagger}$

$^1$Institute of Biology, Martin Luther University Halle-Wittenberg, Am Kirchtor 1, 06108 Halle (Saale), Germany

$^2$German Centre for Integrative Biodiversity Research (iDiv) Halle-Jena-Leipzig, Deutscher Platz 5e, 04103 Leipzig, Germany

$^3$Department of Zoology, 11a Mansfield Rd, University of Oxford, Oxford, OX1 3SZ, UK

$^4$Department of Animal and Plant Sciences, University of Sheffield, Sheffield, S10 2TN, UK

$^5$Department of Community Ecology, Helmholtz Centre for Environmental Research-UFZ, Theodor-Lieser-Stra√üe 4, 06120, Halle (Saale), Germany

$^\ddagger$ Joint senior authors

$^*$Corresponding Author:

Sam C. Levin

Puschstrasse 4, 04103 Leipzig, Germany

email: <levisc8@gmail.com>

Target journal: Probably Methods in Ecology & Evolution, but open to other suggestions.


```{r echo = FALSE, message = FALSE, warning = FALSE}
library(dplyr)
library(purrr)
library(grid)
library(gridExtra)
library(ggplot2)
library(RPadrino)

ipm_pubs <- read.csv('../../../ipmr/data-raw/padr-pubs-feb-2021.csv',
                     stringsAsFactors = FALSE)

names(ipm_pubs) <- gsub("\\.\\.", "_", names(ipm_pubs))
names(ipm_pubs) <- gsub("\\.$", "", names(ipm_pubs))
names(ipm_pubs) <- gsub("\\.", "_", names(ipm_pubs))

ipm_id <- pmap_chr(.l = data.frame(a = ipm_pubs$Authors,
                                   b = ipm_pubs$Journal, 
                                   c = ipm_pubs$Year),
               .f = function(a, b, c) paste(a, b, c, sep = "_")) 

ipm_pubs <- cbind(ipm_pubs, ipm_id)
ipm_pubs$Year <- as.integer(ipm_pubs$Year)

pub_tot  <- length(unique(ipm_id))

kingdoms <- ipm_pubs %>% 
  group_by(Kingdom) %>%
  summarise(N     = length(unique(Full_citation_APA)),
            n_spp = length(unique(Species)))


pdb <- pdb_download(save = FALSE)


tab <- pdb$Metadata %>% 
  group_by(kingdom) %>%
  summarise(
    IPMs = length(unique(ipm_id)),
    spp  = length(unique(species_accepted)),
    pap  = length(unique(apa_citation))
  )

tot <- pdb$Metadata %>% 
  summarise(
    kingdom = "Totals",
    IPMs = length(unique(ipm_id)),
    spp  = length(unique(species_accepted)),
    pap  = length(unique(apa_citation))
  ) %>%
  rbind(tab)




```


## Introduction

Demography is a critical aspect of ecology and evolutionary biology, linking between individuals, populations, and communities (Metcalf & Pavard 2007, Coulson 2012). Integral projection models (IPMs) are a relatively new, but increasingly important tool for ecologists interested in these fields (Easterling et al. 2000, Ellner & Rees 2006). IPMs have been used to investigate a variety of topics, ranging topics such as invasive species spread (_e.g._ Jongejans et al. 2011, Ferrer-Cervantes et al. 2012, Erickson et al. 2017) to evolutionary stable strategies (_e.g._ Childs et al. 2004) to the effect of climate drivers on population persistence (Salguero-Gomez et al. 2012, Compagnoni et al. 2021a). To date, there are at least `r sum(kingdoms$N[1:2])` publications covering at least `r sum(kingdoms$n_spp[1:2])` species (SC Levin, unpublished data). The field of ecology would benefit from a source that enables researchers to reconstruct and analyze these models to address synthetic questions (e.g. Compagnoni et al. 2021b). 

Pressing ecological questions require synthetic approaches. For example, Jelbert and colleagues (2019) used a comprehensive database of discretely structured plant population models (COMPADRE, Salguero-Gomez et al. 2014) to show that demographic amplification predicts degree of invasiveness. Healy and colleagues (2019) used a separate database (COMADRE, Salguero-Gomez et al. 2015) to demonstrate how patterns of animal life history strategies are shaped by trade offs between distributions of age-specific mortality and reproduction. Hartemink & Caswell (2018) decomposed the variance in individual longevity into contributions from individual heterogeneity and individual stochasticity using a set of ten invertebrate species (DATLife Database 2021).  The growing number of IPMs in the literature (Figure 1) indicates that there is a growing, yet currently untapped, source of data that can augment existing approaches and enable novel ones.  

Providing a comprehensive data source to reconstruct IPMs presents a number of unique challenges. IPMs are constructed from continuous functions representing how a trait (or set of traits) predict vital rates (Easterling et al. 2000). To avoid solving the integrals (which are typically too complicated to solve anyway, Ellner & Rees 2006), they are usually numerically approximated, resulting in a large iteration matrix (ranging from $50 \times 50$ to $5000 \times 5000$ in size), and then some population-level quantities of interest are computed. Existing approaches to digitizing structured population models entail entering individual matrix elements, and this is obviously not possible for such large objects (and not preferable, as it precludes certain types of analyses). However, recent advances in computational tools that leverage metaprogramming frameworks mean that we can now construct IPMs from their symbolic representation and the parameters used to implement them without relying on any raw demographic data (Henry & Wickham 2021, Levin et al. 2021). Thus, an approach that digitizes functional forms of sub-kernels, population trait distributions, and vital rate functions can accommodate nearly all of the existing IPM literature.

In this paper, we introduce PADRINO and _RPadrino_. PADRINO houses symbolic representations of IPMs, their parameter values, and associated metadata to aid users in selecting appropriate models. _RPadrino_ provides wrappers around _ipmr_, a framework for implementing IPMs from their symbolic representations, that enable users to reconstruct IPMs from PADRINO with _R_. First, we provide a very brief overview of IPMs and terminology. Next, we describe PADRINO's structure and how to interact with it using _RPadrino_. We conclude with an example of how to use PADRINO and _RPadrino_ to compute a few life history metrics, and discussion of future directions for the database.

## IPM overview (DO we actually need this? Can I just cite another paper?)
    
IPMs describe how the abundance and distribution of a trait (denoted $z$ and $z'$) changes in a population through discrete time (Easterling et al. 2000). The population's trait distribution is given by $n(z, t)$. A simple IPM for the subsequent trait distribution, $n(z',t+1)$ is then:


$$n(z',t+1) = \int_L^U K(z',z)n(z,t) dz.$$ {#eq:eqn1}

The projection kernel, $K(z',z)$, describes all transitions between states $z$ and $z'$ over the course of the projection interval to generate a new trait distribution, $n(z',t+1)$. $L$ and $U$ are the minimum and maximum values that the trait $z$ can take. The integral over $\int_L^Un(z, t)dz$ and $\int_L^Un(z', t+1)dz$ is the total population size at time $t$ and $t+1$, respectively. The projection kernel is usually comprised of sub-kernels, $P(z',z), F(z',z), C(z',z)$. These sub-kernels represent transitions due to survival and change in trait value of existing individuals, sexual reproduction, and asexual reproduction, respectively. These sub-kernels are themselves comprised of additional functions describing vital rates. For example, a $P(z',z)$ kernel may be comprised of three functions - a survival function ($s(z)$), a function describing mean change in trait value of surviving individuals ($G(z',z)$), and a function giving the probability of a new trait value given the mean and variance in trait values:

$$P(z',z) = s(z) * G(z',z),$$ {#eq:eqn2}

$$Logit(s(z)) = \alpha_s + \beta_s * z,$$ {#eq:eqn3}

$$G(z',z) = f_G(z'| \mu_G(z), \sigma_G),$$ {#eq:eqn4}

$$\mu_G(z) = alpha_G + \beta_G * z,$$ {#eq:eqn5}

where $f_G$ denotes some probability density function. The vital rate functions described by equations 3-5 are usually parameterized by fitting generalized linear models to individual level demographic data. 

Analytical solutions to Equation 1 are not practical, and usually impossible (Ellner & Rees 2006), so the kernels are numerically approximated using an integration rule. This produces discrete projection matrices, from which the population state is projected through time. 

## PADRINO

PADRINO is an open-access database of integral projection models. PADRINO defines a syntax to symbolically represent IPMs as text strings, and stores the values of those symbols in a separate table. The syntax used is very similar to the mathematical notation of IPMs. Additionally, PADRINO's syntax is intended to be largely "language-agnostic", meaning it avoids idiosyncracies specific to certain computing languages (_e.g._ R or Julia). For example, the representation of Equation 2 from the section above would be `P = s * G`, and Equation 4 would be represented as `G = Norm(mu_g, sd_g)` (assuming $f_G$ is a normal probability density function. Other distributions are also accommodated in PADRINO). This means that bindings to many languages should be possible provided that a translation layer exists between PADRINO and the language in question. 

PADRINO consists of 10 tables, stored on GitHub as _csv_ files. The table names and a brief description of each are provided in Table 2. Each table is linked to every other table by a common column, called `ipm_id`. For now, this takes the place of an SQL key, and ensures that all information pertaining to a given model is linked to every other piece of the model correctly (PADRINO will eventually become an SQL database hosted elsewhere, but for now, it is only on GitHub). The scope of each `ipm_id` is determined by the way that a model is parameterized. Models that characterize the same species across, for example, many years or sites, with the same functional form are considered included as a single `ipm_id`. One exception to this is when the sites (i.e. where the raw data are reported to have come from) are far enough apart that separate sets of GPS coordinates are used to describe them. These are split into separate `ipm_id`s so that the spatial distinctions are preserved, which facilitates matching PADRINO data with, for example, gridded environmental data. 

```{r echo = FALSE}

cap <- "**Table 1**: The number of studies in PADRINO broken down by kingdom. These represent the number of models that are error checked and considered production quality (see 'Data Validation' for more details). Models that are entered, but do not pass error checking are not considered here."
  
knitr::kable(tot,
             col.names = c("Kingdom", 
                           "# of Unique ipm_id's", 
                           "# of Unique Species",
                           "# of Publications"),
             caption = cap)

```

To date, we have incorporated and tested `r tot[3, 2]` IPMs for `r tot[3, 3]` species from `r tot[3, 4]` publications (Table 1). We are actively working on collecting and digitizing every published IPM we can find, though challenges arise in the process (see below).

```{r echo = FALSE}

cap <- "**Table 2**: Summaries of the information contained in each table of the PADRINO database. A complete guide to each column in each table is available on the project's webpage in the form of the guide provided to digitizers (there are too many columns to provide the information here)."

md_desc <- "This table contains metadata for each model. This is organized into taxonomic information (full taxonomy plus functional group information), publication information (citation, authorship, source), data collection information (study period/duration, GPS coordinates, ecoregion), and model specific information (studied sexes, eviction corrections, treatments applied, and model implementation details). See Table 3 for more information on these columns."

sv_desc <- "This table contains the names of the state variables used in the model and whether or not they are discrete or continuously distributed."

cd_desc <- "This table contains names and ranges for each continuously distributed state variable in the model, as well as which kernels they apply to."

ir_desc <- "This table contains information on how each continuous state variable is numerically approximated in the model (i.e. number of meshpoints, which integration rule was used)."

ps_desc <- "This table contains the names of the population trait distributions used in the model (i.e. the $n(z,t)$/$n(z,t+1)$ from Equation 1)."

ik_desc <- "This table contains the functional forms of each sub-kernel in the IPM (e.g. $P(z',z) = s(z) * G(z',z)$ in Equation 2 is entered as `P = s * G`), and information on which traits it acts on and creates. This table makes use of _ipmr_'s parameter set index notation to concisely represent models which may produce many kernels."

vr_desc <- "This table contains the functional forms of each vital rate in the IPM (e.g. $\\mu_G(z) = \\alpha_G + \\beta_G * z$ from Equation 5 is entered as `mu_g = int_g + slope_g * z_1`). This table makes use of _ipmr_'s parameter set index notation to concisely represent models which may produce many kernels."

pv_desc <- "This table contains the names and values of each parameter in the model, with the exception of parameters that are associated with continuous environmental variation."

ev_desc <- "This table contains parameter values and functional forms of any continuously varying environmental conditions (e.g. precipitation, temperature). Any model that contains information in this table is considered stochastic by default, as these variables must be sampled at least once to construct a model with _RPadrino_."

pi_desc <- "This table contains the parameter set indices. These are substituted into the IPM kernels and vital rate expressions when a model is built, so that a single symbolic expression can represent an arbitrary number of realized expression. For example, the vital rate expression `mu_g_yr = g_int_yr + g_slope * z_1` can be used to represent a range of years for a model with year-specific intercepts. This table contains values substituted in for `'_yr'` across the model. See the [ipmr vignette on Index Notation](https://levisc8.github.io/ipmr/articles/index-notation.html) for more details."

col_df <- data.frame(
  tab_nm = c("Metadata", 
             "State Variables",
             "Continuous States",
             "Integration Rules",
             "Population Trait Distributions",
             "IPM Sub-kernels",
             "Vital Rate Functions",
             "Parameter Values",
             "Continuous Environmental Variation",
             "Parameter Set Indices"),
  description = c(md_desc,
                  sv_desc,
                  cd_desc,
                  ir_desc,
                  ps_desc,
                  ik_desc,
                  vr_desc,
                  pv_desc,
                  ev_desc,
                  pi_desc) 
)

knitr::kable(col_df,
             col.names = c("Table", "Description"),
             caption = cap)

```



## RPadrino

The syntax described above is unlikely to be useful on its own. We've also written an _R_ package that translates PADRINO's syntax into _ipmr_'s syntax (Levin et al. 2021). _ipmr_ provides a generalized engine for implementing IPMs in _R_, and can construct nearly all types of IPMs that currently exist (there are exceptions to this, though methods to accommodate these exceptions are in active development). _RPadrino_ also contains functions for downloading the PADRINO database, data querying and management, and modifying existing functional forms and parameter values. This provides a basis for a variety of synthetic analyses using the _R_ programming language. 

_RPadrino_ is explicitly designed to handle syntheses that incorporate data not already in PADRINO. It does this by introducing an intermediate step between PADRINO and a set of kernels - the `proto_ipm`. This data structure is also used in _ipmr_ to represent IPM objects before the expressions are evaluated - thus creating a common data structure between user-specified IPMs and ones created from PADRINO. This means that users may combine their own information with that from PADRINO to further enhance the scope of their syntheses. Furthermore, we are working on creating functionality that translates a `proto_ipm` object backwards into PADRINO's data structure, which will greatly reduce the issues we encounter when digitizing publications (see below).

## Data Validation

PADRINO has automated testing built into the data release process. All models are checked to ensure they recover the behavior of the published version. Because publications vary greatly in their goals, this can encompass a variety of metrics. In most cases, this means reproducing the kernel-specific asymptotic population growth rate to a given tolerance level (usually to within $\pm 0.03$ of the published per-capita growth rate). It is worth noting that this margin of error is considerably less than the uncertainty that arises from fitting statistical models to the raw data used to fit the IPM. For stochastic models with continuously varying environments, it is often not computationally feasible to re-run the IPM for 10-50,000 iterations. Thus, we manually check for shorter term behavior that is similar to published dynamics (e.g. $\lambda_s$ after 1000 iterations). For publications where this type of information is not available, we manually examine the publication and check the entered model against some reported behavior. A model cannot enter a released version of the database unless it is explicitly flagged by a digitizer as validated, or passes its automated test. The testing functionality is contained in the open source _R_ package _pdbDigitUtils_, available on [GitHub](https://github.com/levisc8/pdbDigitUtils). 


```{r echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Cumulative number of publications in Padrino by year, and their geographic distribution. This figure only depicts publications that have been fully digitized and validated - there are many more studies that are currently in digitization process, but not yet ready."}

met <- pdb$Metadata

pub_rates <- met %>%
  filter(!duplicated(apa_citation)) %>%
  group_by(pub_year) %>%
  summarise(n_tot = n()) %>%
  ungroup() %>%
  arrange(pub_year) %>%
  mutate(run_sum = cumsum(n_tot))

wrld_data <- met %>%
  mutate(lat = as.numeric(lat),
         lon = as.numeric(lon)) %>%
  filter(!is.na(lat) | !is.na(lon))

wrld <- map_data("world")

rate_plt <- ggplot(pub_rates,
                   aes(x = pub_year,
                       y = run_sum)) +
  geom_line(size = 1.25) +
  theme_bw() +
  ylab("Cumulative Publications") +
  xlab("Year")

wrld_plt <- ggplot(wrld,
                   aes(x     = long,
                       y     = lat,
                       group = group)) +
  geom_polygon(color = "grey50",
               fill = NA) + 
  coord_map(xlim = c(-180, 180)) +
  geom_point(data = wrld_data,
             aes(x = lon,
                 y = lat),
             color = "blue",
             size = 1.5,
             alpha = 0.6,
             inherit.aes = FALSE) +
  theme_bw() +
  xlab("Longitude") +
  ylab("Latitude")

grid.arrange(wrld_plt, rate_plt,
             layout_matrix = matrix(c(1, 1,
                                      1, 1,
                                      1, 1,
                                      2, 2,
                                      2, 2),
                                    nrow = 5,
                                    ncol = 2,
                                    byrow = TRUE))

```


## Opportunities

6. Padrino presents unique opportunities for synthesis

    + Estimates of life history traits derived from matrix models for some species, particularly trees, may suffer from the discretizing fairly large size ranges and/or ontogenic stages into a single value. IPMs may alleviate this issue and provide more accurate estimates
    
    + Expanded range of species and geographical coverage can be used in conjunction with other demographic databases (e.g. COM(P)ADRE, D3) to power large scale syntheses than were possible before
    
      + Padrino is designed to play nicely with Com(p)adre. Metadata variables have very similar names and meanings so if you're already familiar with one, then you're pretty familiar with the other.
    
7. Borrowing strength across the phylogenetic tree to advance conservation goals and test theory

    + Integrate w/ UN/IUCN/other global conservation assessments. Recent developments in modelling coupled-species extinction risk mean that we now have a theoretical toolbox (e.g. Simmonds et al 2020) to look at species level risks at short to intermediate term. 
   
    + Test the phylogeny -> trait -> LH linkage at finer resolutions (Adler et al. 2014).
    
    + Modifying functional forms combined with simulation approaches gives theoreticians an array of realistic life-histories to experiment with.

    

```{r echo = FALSE, message = FALSE, warning = FALSE}

library(knitr)

met_tab <- data.frame(
  concept = c(
    NA_character_,
    "Taxonomy",
    rep(NA_character_, 10),
    "Source",
    rep(NA_character_, 8),
    "Temporal Metadata",
    rep(NA_character_, 5),
    "Spatial Metadata",
    rep(NA_character_, 7),
    "Model-specific metadata",
    rep(NA_character_, 5)
  ),
  var_nm = c(
    "ipm_id",
    "species_author",
    "species_accepted", 
    "tax_genus", 
    "tax_family", 
    "tax_order", 
    "tax_class",
    "tax_phylum",
    "kingdom", 
    "organism_type", 
    "dicot_monocot", 
    "angio_gymno", 
    "authors",
    "journal", 
    "pub_year", 
    "doi", 
    "corresponding_author", 
    "email_year",
    "remark", 
    "apa_citation",
    "demog_appendix_link", 
    "duration",
    "start_year", 
    "start_month", 
    "end_year",
    "end_month", 
    "periodicity", 
    "population_name", 
    "number_populations", 
    "lat", 
    "lon",
    "altitude", 
    "country", 
    "continent", 
    "ecoregion", 
    "studied_sex", 
    "eviction_used", 
    "evict_type",
    "treatment", 
    "has_time_lag", 
    "has_age"
  ),
  Description = c(
    "Unique ID for each model",
    "The Latin species name used by the authors of the paper",
    "The Latin species name accepted by XYZ Service",
    "The Latin genus name accepted by XYZ Service",
    "The Latin family name accepted by XYZ Service",
    "The Latin order name accepted by XYZ Service",
    "The Latin class name accepted by XYZ Service",
    "The Latin phylum name accepted by XYZ Service",
    "The Latin kingdom name accepted by XYZ Service",
    "General functional type of the species (e.g. annual, fern, mammal, reptile)",
    "If a plant species, whether the species is a dicot or a monocot",
    "If a plant species, whether the species is an angiosperm, gymnosperm, or neither",
    "All of a study authors' last names, separated with a ';'",
    "Abbreviated journal name (www.abbreviations.com/jas.php), or 'PhD', 'MSc' if a thesis",
    "The year of publication",
    "Digital object identifier and/or ISBN (if available)",
    "The name of the corresponding author on the paper",
    "The email address of the corresponding author and the year it was extracted (some email addresses may be defunct now)",
    "Additional remarks from the digitizer regarding the publication, if any",
    "The full APA citation for the source",
    "The URL for the Supplementary information containing additional model details, if available",
    "The duration of the study, defined 'study_end - study_start + 1'. Does not consider skipped years",
    "The year demographic data collection began",
    "The month demohraphic data collection began",
    "The year demographic data collection ended",
    "The month demographic data collection ended",
    "Frequency of the model (1: annual transition, 2: semi-annual transition, 0.2: 5 year transition)",
    "The name of the population given in the data source",
    "The number of populations that a given model describes",
    "The decimal latitude of the population",
    "The decimal longitude of the population",
    "The altitude of the population above sea level, obtained either from the publication or Google Earth",
    "The country or countries in which the data were collected",
    "The continent or continents on which the data were collected",
    "The terrestrial or aquatic ecoregion corresponding to Olson et al. (2001) classification. If data are from a controlled setting (greenhouse, lab), denoted with 'LAB'",
    "Sexes used to construct the model",
    "Whether or not the authors explicitly state that they corrected for eviction (see Williams et al. 2012)",
    "If the authors did correct for eviction, then the type of correction that was applied",
    "A description of any experimental treatment applied to the population",
    "Whether or not the model contains a time lagged vital rate/kernel",
    "Whether or not the model has age structure in addition to other continuous state variables"
  )
  
)

met_tab$concept[is.na(met_tab$concept)] <- ""


kable(met_tab)
```
    
    
## Citations

1. Easterling et al. 

2. Ellner & Rees 2006 General IPMs

3. Hartemink & Caswell (2018) 

4. DatLife

5. Comadre

6. Compadre

7. Aldo 2021 Ecosphere

8. Aldo 2021 Nat Comms

9. Levin 2021 ipmr

10. Jongejans 2011 Carduus

11. Ferrer-Cervantes 2012 

12. Jelbert 2019 Amplification/invasives

13. Erickson 2017 carps

14. Childs 2004 ESS